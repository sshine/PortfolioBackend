name: Auto-assign Metadata

on:
  issues:
    types: [opened, labeled]

jobs:
  auto-assign:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Add to Project and Set Fields
        uses: actions/add-to-project@31b3f3ccdc584546fc445612dec3f38ff5edb41c # v1.0.1
        id: add-project
        with:
          project-url: https://github.com/orgs/TeamOrnOps/projects/3
          github-token: ${{ secrets.PROJECT_TOKEN }}

      - name: Set Type and Status
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const issueName = issue.title.toLowerCase();
            const body = (issue.body || '').toLowerCase();
            
            // Determine the type based on title
            let issueType = 'Task'; // default
            if (issueName.includes('[bug]')) {
              issueType = 'Bug';
            } else if (issueName.includes('[feature]') || issueName.includes('[story]')) {
              issueType = 'Feature';
            } else if (issueName.includes('[task]')) {
              issueType = 'Task';
            }
            
            // Issues go to "Backlog"
            let status = 'Backlog';
            
            console.log(`Setting Type: ${issueType}, Status: ${status}`);
            
            // Track what was automated for comment
            const automationActions = [];
            
            // Get the project item ID that was just added
            const projectItemId = '${{ steps.add-project.outputs.itemId }}';
            
            if (projectItemId) {
              // Query to get project field IDs
              const projectQuery = `
                query($org: String!, $number: Int!) {
                  organization(login: $org) {
                    projectV2(number: $number) {
                      id
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
            
              const projectData = await github.graphql(projectQuery, {
                org: 'TeamOrnOps',
                number: 3
              });
            
              const project = projectData.organization.projectV2;
              const fields = project.fields.nodes;
            
              // Find Type and Status fields
              const typeField = fields.find(f => f.name === 'Type');
              const statusField = fields.find(f => f.name === 'Status');
            
              // Update Type field
              if (typeField) {
                const typeOption = typeField.options.find(o => o.name === issueType);
                if (typeOption) {
                  await github.graphql(`
                    mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                      updateProjectV2ItemFieldValue(
                        input: {
                          projectId: $projectId
                          itemId: $itemId
                          fieldId: $fieldId
                          value: { singleSelectOptionId: $optionId }
                        }
                      ) {
                        projectV2Item {
                          id
                        }
                      }
                    }
                  `, {
                    projectId: project.id,
                    itemId: projectItemId,
                    fieldId: typeField.id,
                    optionId: typeOption.id
                  });
                  console.log(`âœ… Set Type to: ${issueType}`);
                  automationActions.push(`**Type** set to: \`${issueType}\``);
                }
              }
            
              // Update Status field
              if (statusField) {
                const statusOption = statusField.options.find(o => o.name === status);
                if (statusOption) {
                  await github.graphql(`
                    mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                      updateProjectV2ItemFieldValue(
                        input: {
                          projectId: $projectId
                          itemId: $itemId
                          fieldId: $fieldId
                          value: { singleSelectOptionId: $optionId }
                        }
                      ) {
                        projectV2Item {
                          id
                        }
                      }
                    }
                  `, {
                    projectId: project.id,
                    itemId: projectItemId,
                    fieldId: statusField.id,
                    optionId: statusOption.id
                  });
                  console.log(`âœ… Set Status to: ${status}`);
                  automationActions.push(`**Status** set to: \`${status}\``);
                }
              }
            
              // Post comment about automation
              if (automationActions.length > 0) {
                const commentBody = `ğŸ¤– **Automated Actions**\n\n${automationActions.map(a => `- ${a}`).join('\n')}\n\nâœ… Added to [Scrum Board](https://github.com/orgs/TeamOrnOps/projects/3)`;
            
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: commentBody
                });
              }
            }

      - name: Auto-label based on type
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const issue = context.payload.issue;
            const issueName = issue.title.toLowerCase();
            const labels = [];
            
            // Add labels based on title prefix
            if (issueName.includes('[story]')) {
              labels.push('user story');
            }
            if (issueName.includes('[tech]') || issueName.includes('[technical]')) {
              labels.push('technical story');
            }
            if (issueName.includes('[doc]')) {
              labels.push('documentation');
            }
            
            // Add component labels based on content
            const body = (issue.body || '').toLowerCase();
            
            if (body.includes('backend') || body.includes('api')) {
              labels.push('backend');
            }
            if (body.includes('database') || body.includes('db') || body.includes('sql')) {
              labels.push('database');
            }
            if (body.includes('documentation') || body.includes('readme') || body.includes('diagram')) {
              labels.push('documentation');
            }
            
            // Add labels if we found any
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
            
              console.log(`âœ… Auto-applied labels: ${labels.join(', ')}`);
            
              // Post comment about labels
              const labelList = labels.map(l => `\`${l}\``).join(', ');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `ğŸ·ï¸ Auto-applied labels: ${labelList}`
              });
            }
