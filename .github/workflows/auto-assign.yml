name: Auto-assign Metadata

on:
  issues:
    types: [opened, labeled]
  pull_request:
    types: [opened, labeled]

jobs:
  auto-assign:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read
    
    steps:
      - name: Add to Project
        uses: actions/add-to-project@31b3f3ccdc584546fc445612dec3f38ff5edb41c # v1.0.1
        with:
          project-url: https://github.com/orgs/TeamOrnOps/projects/3
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Auto-label based on type
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const issue = context.payload.issue || context.payload.pull_request;
            const issueName = issue.title.toLowerCase();
            const labels = [];
            
            // Add labels based on title prefix
            if (issueName.includes('[story]')) {
              labels.push('user story');
            }
            if (issueName.includes('[tech]') || issueName.includes('[technical]')) {
              labels.push('technical story');
            }
            
            // Add component labels based on content
            const body = (issue.body || '').toLowerCase();
            
            if (body.includes('backend') || body.includes('api')) {
              labels.push('backend');
            }
            if (body.includes('database') || body.includes('db') || body.includes('sql')) {
              labels.push('database');
            }
            if (body.includes('documentation') || body.includes('readme') || body.includes('diagram')) {
              labels.push('documentation');
            }
            
            // Add labels if we found any
            if (labels.length > 0) {
              if (context.payload.issue) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: labels
                });
              } else if (context.payload.pull_request) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: labels
                });
              }
            }
